var e={d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{m:()=>_,w:()=>u});class s{constructor(e){this.__kernox=e,this.__namespaces=new Set}use(e){const{name:t}=e;if(this.namespaces.has(t))throw new Error(`Conflict with already existing namespace '${t}', please consider renaming one of them.`);e.collections&&this.registerCollections(e.collections,t),e.prototypes&&this.registerPrototypes(e.prototypes,t),e.systems&&this.registerSystems(e.systems,t),this.namespaces.add(t)}get namespaces(){return this.__namespaces}registerPrototypes(e,t){e.forEach((e=>{this.__kernox.entityFactory.prototype(e,t)}))}registerCollections(e,t){e.forEach((e=>{this.__kernox.collectionManager.use(e,t)}))}registerSystems(e,t){e.forEach((e=>{this.__kernox.systemManager.use(e,t)}))}}class r{}function i(e,t){let s=e.prototype;for(;s;)if(s=Object.getPrototypeOf(s),s===t.prototype)return!0;return!1}class o{constructor(e){this.__kernox=e,this.collections=new Map,this.toRemove=new Set}get(e){const t=this.collections.get(e)||this.resolveImplicitNamespace(e);if(!t)throw new Error(`Collection '${e}' is not registered.`);return t}use(e,t=""){if(!i(e,r))throw new Error("Invalid collection: it must be a sub-class of AbstractCollection");const s=t?`${t}.${e.name}`:e.name;if(this.collections.has(s))throw new Error(`Cannot register collection '${s}' because it already exists`);const o=new e;this.collections.set(s,o)}addEntityTo(e,t){this.get(t).insert(e),e.linkTo(t)}removeEntityFrom(e,t){this.get(t).remove(e),e.unlinkFrom(t)}remindToForget(e){this.toRemove.add(e)}flushRemoved(){for(const e of this.toRemove)for(const t of e.collections())this.removeEntityFrom(e,t);this.toRemove.clear()}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,r;for(const i of t)if((r=this.collections.get(`${i}.${e}`))&&!s)s=r;else if(r)throw new Error(`Ambiguous collection '${e}' was requested: a namespace must be specified before it ( Ex. namespace.collectionName ).`);return s}}class n{constructor(e,t){this.__ID=e,this.__TYPE=t,this.__children={},this.__collections=new Set,this.__modified=!1}get id(){return this.__ID}get type(){return this.__TYPE}belongsTo(e){return this.__collections.has(e)}collections(){return this.__collections}linkTo(e){this.__collections.add(e)}unlinkFrom(e){this.__collections.delete(e)}appendChild(e,t){if(this.__children[e])throw Error(`Child already exists with name '${e}' at entity '${this.__ID}'`);this.__children[e]=t}getChild(e){return this.__children[e]}deleteChild(e){delete this.__children[e]}}class a{constructor(e){this.__kernox=e,this.types=new Map,this.pools=new Map,this.nextID=0}prototype(e,t=""){const s=t?`${t}.${e.name}`:e.name;if(this.types.has(s))throw Error(`The type named '${s}' has already been registered`);const{inherits:r}=e;if(r){const t=r,s=[];for(const e of t)s.push(e);let i=s.pop();for(;i;){const t={};this.deepAssign(t,i.attributes),this.deepAssign(t,e.attributes),e.attributes=t,e.collections=new Set([...e.collections||[],...i.collections||[]]);for(const e of i.inherits||[])s.push(e);i=s.pop()}}this.types.set(s,e)}create(e,t={}){const s=this.types.get(e)||this.resolveImplicitNamespace(e);if(!s)throw Error(`Cannot create entity of null type '${e}'`);const r=new n(""+this.nextID++,e);this.deepAssign(r,s.attributes);for(const e of Object.keys(t))e in r&&!e.includes("_")&&(r[e]=t[e]);const i=e.split("."),o=2==i.length?i[0]:void 0;for(let e of s.collections||[])o&&(e=`${o}.${e}`),this.__kernox.collectionManager.addEntityTo(r,e),r.linkTo(e);return r}copyFromPrototype(e,t){this.deepAssign(e,t.attributes)}sendToRest(e){}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,r;for(const i of t)if((r=this.types.get(`${i}.${e}`))&&!s)s=r;else if(r)throw new Error(`Ambiguous entity type '${e}' was requested: a namespace must be specified before it ( Ex. namespace.type ).`);return s}deepAssign(e,t,s=new WeakMap){if(!s.has(t)){s.set(t,e);for(const r of Object.keys(t)){const i=t[r];null===i||"object"!=typeof i?e[r]=i:Array.isArray(i)?(e[r]=[],this.deepAssign(e[r],i,s)):i.constructor!==Object?(e[r]=new i.constructor,this.deepAssign(e[r],i,s)):(e[r]={},this.deepAssign(e[r],i,s))}}}}class c{constructor(e){this.__kernox=e,this.listeners=new Map}dispatch(e,t){const s=this.listeners[e]||this.resolveImplicitNamespace(e);if(!s)return!1;for(const e of s)e(t);return!0}attachToEvent(e,t){if(!e||"string"!=typeof e)throw new Error("[EventManager] invalid event name provided: it must be a non-empty string");if("function"!=typeof t)throw new Error("Expected function as 'handler'");return this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t)}resolveImplicitNamespace(e){const t=this.__kernox.addonLoader.namespaces;var s,r;for(const i of t)if((r=this.listeners[`${i}.${e}`])&&!s)s=r;else if(r)throw new Error(`Ambiguous event '${e}' was requested: a namespace must be specified before it ( Ex. namespace.eventName ).`);return s}}class h{constructor(e,t){this.__kernox=e,this.__context=t,this.__paused=!1}init(){}execute(){}get context(){return this.__context}get paused(){return this.__paused}set paused(e){this.__paused=e}attachToEvent(e,t){const s=this.resolveResourceName(e);return this.__kernox.eventBroker.attachToEvent(s,t)}dispatchEvent(e,t){this.__kernox.eventBroker.dispatch(e,t)}getCollection(e){const t=this.resolveResourceName(e),s=this.__kernox.collectionManager.get(t);if(!s)throw Error(`Collection '${t}' was not found`);return s}resolveResourceName(e){const t=e.split(".");var s=this.context,r=e;2==t.length&&([s,r]=t);return s?`${s}.${r}`:e}}class l{constructor(e){this.__kernox=e,this.systems=new Map,this.executionList=[]}execute(){this.executionList.forEach((e=>{e.paused||e.execute()}))}use(e,t=""){const s=t?`${t}.${e.name}`:e.name;if(!i(e,h))throw new Error("Expected instance of 'System'");if(this.systems.has(s))return console.warn(`System '${s}' is already registered`),!1;const r=new e(this.__kernox,t);return r.init(),this.systems.set(s,r),this.executionList.push(r),!0}unuse(e){const t=this.systems.get(e);t&&(this.systems.delete(e),this.executionList=this.executionList.filter((e=>e!==t)))}get(e){return this.systems.get(e)}}class _ extends r{constructor(){super(...arguments),this.entities=new Set,this.__changed=!1}insert(e){return!this.has(e)&&(this.entities.add(e),e.linkTo(this.constructor.name),this.__changed=!0,!0)}remove(e){return!!this.entities.delete(e)&&(e.unlinkFrom(this.constructor.name),this.__changed=!0,!0)}has(e){return this.entities.has(e)}*[Symbol.iterator](){const e=this.toArray();for(let t=0;t<this.size();t++)yield e[t]}iterator(e=0,t=-1,s=1){if(0==s)throw Error("Attempted to create non-changing iterator: 'step' parameter cannot be zero");const r=this.size();t<0&&(t=r-t),e=Math.max(0,e)-1,t=Math.min(t,r-1);var i=e;const o=this.toArray();return{[Symbol.iterator](){return this},next:()=>i<r&&i<=t?{value:o[i+=s],done:!1}:{value:void 0,done:!0}}}toArray(){return Array.from(this.entities)}filter(e){return this.toArray().filter(e)}size(){return this.entities.size}get changed(){return this.__changed}}class u{constructor(){this.__entityFactory=new a(this),this.__collectionManager=new o(this),this.__systemManager=new l(this),this.__eventBroker=new c(this),this.__addonLoader=new s(this),this.__frame=0,this.__paused=!1,this.__lastTime=0,this.__dt=1,this.__fps=0}execute(e=30){try{if(this.paused)return;this.__dt=e-this.__lastTime,this.__fps=1e3/this.dt,this.__lastTime=e,requestAnimationFrame((e=>this.execute(e))),this.__systemManager.execute(),this.__frame++}catch(e){console.error(e),console.warn("A run-time error has occurred, execution was paused"),this.__paused=!0}}use(e){this.__addonLoader.use(e)}get entityFactory(){return this.__entityFactory}get collectionManager(){return this.__collectionManager}get systemManager(){return this.__systemManager}get eventBroker(){return this.__eventBroker}get addonLoader(){return this.__addonLoader}get frame(){return this.__frame}get paused(){return this.__paused}get dt(){return this.__dt}get fps(){return this.__fps}}var d=t.m,p=t.w;export{d as ArrayList,p as Kernox};